
  ___  ____  ____  ____  ____ (R)
 /__    /   ____/   /   ____/
___/   /   /___/   /   /___/   13.0   Copyright 1985-2013 StataCorp LP
  Statistics/Data Analysis            StataCorp
                                      4905 Lakeway Drive
     MP - Parallel Edition            College Station, Texas 77845 USA
                                      800-STATA-PC        http://www.stata.com
                                      979-696-4600        stata@stata.com
                                      979-696-4601 (fax)

2-user 16-core Stata network perpetual license:
       Serial number:  501306200703
         Licensed to:  HPC, ITS
                       New York University, NY

Notes:
      1.  (-v# option or -set maxvar-) 5000 maximum variables
      2.  Command line editing disabled
      3.  Stata running in batch mode

Note:  Your site can add messages to the introduction by editing the file
       stata.msg in the directory where Stata is installed.

. do 130809_regressions_all_years.do 

. * CREATE FILES FOR THE REGRESSION
. * CHOOSE THE CONTROL AND TREATMENT GROUPS, MATCH THEM WITH THE HISTORY
. 
. local filepath "/scratch/kb103/stata/earnings_losses"

. 
. ***** CREATE FILES****************************************
. /*
> use "`filepath'/control_Davis_ind_1.dta"
> forval ii = 2/10{
>         append using "`filepath'/control_Davis_ind_`ii'.dta"
> }
> gen int year_mass_layoff = year+1
> save "`filepath'/control_Davis_ind_all.dta", replace
> 
> clear
> 
> use "`filepath'/control_treatment_ind_1.dta"
> forval ii = 2/10{
>         append using "`filepath'/control_treatment_ind_`ii'.dta"
> }
> gen int year_mass_layoff = year
> save "`filepath'/control_treatment_ind_all.dta", replace
> 
> clear
> use "`filepath'/control_Davis_ind_all.dta"
> append using "`filepath'/control_treatment_ind_all.dta"
> save "`filepath'/control_treatment_all_measures.dta"
> 
> clear
> 
> use "`filepath'/employed_UStype_1_0.dta"
> append using "`filepath'/employed_UStype_1_1.dta"
> forval ii = 2/10{
>         append using "`filepath'/employed_UStype_`ii'_0.dta"
>         append using "`filepath'/employed_UStype_`ii'_1.dta"
> }
> save "`filepath'/employed_UStype_all.dta", replace
> 
> */
. 
. /*
> ***** THIS IS JUST A TESTING SAMPLE ******************************
> 
> use "`filepath'/employed_UStype_1_1.dta"
> gen double r=runiform()
> keep if r<0.1
> saveold "`filepath'/employed_UStype_1_1_sample.dta", replace
> 
> use  "`filepath'/control_treatment_ind_all.dta", replace
> keep if year_mass_layoff==1982
> saveold "`filepath'/control_treatment_ind_all_1982.dta", replace
> 
> */
. 
. ***** CREATE FILES FOR EACH YEAR ******************************
. 
. forval yy = 2005/2007{
  2.         
.         * TREATMENT AND CONTROL IN A GIVEN DISPLACEMENT YEAR
.         use "`filepath'/control_treatment_ind_all.dta", clear
  3.         keep if year_mass_layoff ==`yy'
  4.         sort pid fid days_worked_beginning
  5.         drop if days_worked_beginning==.
  6.         drop if days_worked_beginning<100
  7.         by pid fid: gen int index = _n
  8.         keep if index ==1
  9.         drop index
 10.         by pid: gen int index = _n
 11.         by pid: egen int index2 = max(index)
 12.         save "`filepath'/temp_`yy'.dta", replace
 13.         
.         drop if index2>1
 14.         drop index index2
 15.         rename fid fid_ML 
 16.         drop year
 17.         save "`filepath'/control_treatment_ind_year`yy'.dta", replace
 18.         
.         use "`filepath'/temp_`yy'.dta", clear
 19.         keep if index2>1
 20.         rename fid fid_ML 
 21.         drop year
 22.         save "`filepath'/control_treatment_ind_multi_year`yy'.dta", replac
> e
 23.         
.         * DAVIS MEASURE
.         use "`filepath'/control_Davis_ind_all.dta", clear
 24.         keep if year_mass_layoff ==`yy'
 25.         sort pid fid days_worked_beginning
 26.         drop if days_worked_beginning==.
 27.         drop if days_worked_beginning<100
 28.         by pid fid: gen int index = _n
 29.         keep if index ==1
 30.         drop index
 31.         by pid: gen int index = _n
 32.         by pid: egen int index2 = max(index)
 33.         save "`filepath'/Dtemp_`yy'.dta", replace
 34.         
.         drop if index2>1
 35.         drop index index2
 36.         rename fid fid_ML 
 37.         drop year
 38.         save "`filepath'/control_Davis_ind_year`yy'.dta", replace
 39.         
.         use "`filepath'/Dtemp_`yy'.dta", clear
 40.         keep if index>1
 41.         rename fid fid_ML 
 42.         drop year
 43.         save "`filepath'/control_Davis_ind_multi_year`yy'.dta", replace
 44. 
.         * MERGE WITH EMPLOYMENT SPELLS
.         use "`filepath'/employed_UStype_all.dta", clear
 45.         merge m:1 pid using "`filepath'/control_treatment_ind_year`yy'.dta
> ", keep(match)
 46.         save "`filepath'/EL_ind_year`yy'.dta", replace
 47.         
.         * MERGE WITH EMPLOYMENT SPELLS
.         use "`filepath'/employed_UStype_all.dta", clear
 48.         merge m:1 pid using "`filepath'/control_Davis_ind_year`yy'.dta", k
> eep(match)
 49.         save "`filepath'/EL_Davis_ind_year`yy'.dta", replace
 50.         
. }
(28088597 observations deleted)
(511 observations deleted)
(2329 observations deleted)
(33184 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/temp_2005.dta not found)
file /scratch/kb103/stata/earnings_losses/temp_2005.dta saved
(5025 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_treatment_ind_year2005
> .dta not found)
file /scratch/kb103/stata/earnings_losses/control_treatment_ind_year2005.dta sa
> ved
(905651 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_treatment_ind_multi_ye
> ar2005.dta not found)
file /scratch/kb103/stata/earnings_losses/control_treatment_ind_multi_year2005.
> dta saved
(527103 observations deleted)
(0 observations deleted)
(117 observations deleted)
(397 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/Dtemp_2005.dta not found)
file /scratch/kb103/stata/earnings_losses/Dtemp_2005.dta saved
(0 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_Davis_ind_year2005.dta
>  not found)
file /scratch/kb103/stata/earnings_losses/control_Davis_ind_year2005.dta saved
(15122 observations deleted)
(note: dataset contains 0 observations)
(note: file /scratch/kb103/stata/earnings_losses/control_Davis_ind_multi_year20
> 05.dta not found)
file /scratch/kb103/stata/earnings_losses/control_Davis_ind_multi_year2005.dta 
> saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                        22,827,619  (_merge==3)
    -----------------------------------------
(note: file /scratch/kb103/stata/earnings_losses/EL_ind_year2005.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_ind_year2005.dta saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           365,946  (_merge==3)
    -----------------------------------------
(note: file /scratch/kb103/stata/earnings_losses/EL_Davis_ind_year2005.dta not 
> found)
file /scratch/kb103/stata/earnings_losses/EL_Davis_ind_year2005.dta saved
(29016727 observations deleted)
(536 observations deleted)
(148 observations deleted)
(781 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/temp_2006.dta not found)
file /scratch/kb103/stata/earnings_losses/temp_2006.dta saved
(20 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_treatment_ind_year2006
> .dta not found)
file /scratch/kb103/stata/earnings_losses/control_treatment_ind_year2006.dta sa
> ved
(17085 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_treatment_ind_multi_ye
> ar2006.dta not found)
file /scratch/kb103/stata/earnings_losses/control_treatment_ind_multi_year2006.
> dta saved
(525109 observations deleted)
(0 observations deleted)
(120 observations deleted)
(427 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/Dtemp_2006.dta not found)
file /scratch/kb103/stata/earnings_losses/Dtemp_2006.dta saved
(0 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_Davis_ind_year2006.dta
>  not found)
file /scratch/kb103/stata/earnings_losses/control_Davis_ind_year2006.dta saved
(17083 observations deleted)
(note: dataset contains 0 observations)
(note: file /scratch/kb103/stata/earnings_losses/control_Davis_ind_multi_year20
> 06.dta not found)
file /scratch/kb103/stata/earnings_losses/control_Davis_ind_multi_year2006.dta 
> saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           397,341  (_merge==3)
    -----------------------------------------
(note: file /scratch/kb103/stata/earnings_losses/EL_ind_year2006.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_ind_year2006.dta saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           412,685  (_merge==3)
    -----------------------------------------
(note: file /scratch/kb103/stata/earnings_losses/EL_Davis_ind_year2006.dta not 
> found)
file /scratch/kb103/stata/earnings_losses/EL_Davis_ind_year2006.dta saved
(28991166 observations deleted)
(513 observations deleted)
(187 observations deleted)
(1058 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/temp_2007.dta not found)
file /scratch/kb103/stata/earnings_losses/temp_2007.dta saved
(18 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_treatment_ind_year2007
> .dta not found)
file /scratch/kb103/stata/earnings_losses/control_treatment_ind_year2007.dta sa
> ved
(42355 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_treatment_ind_multi_ye
> ar2007.dta not found)
file /scratch/kb103/stata/earnings_losses/control_treatment_ind_multi_year2007.
> dta saved
(520555 observations deleted)
(0 observations deleted)
(285 observations deleted)
(834 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/Dtemp_2007.dta not found)
file /scratch/kb103/stata/earnings_losses/Dtemp_2007.dta saved
(2 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_Davis_ind_year2007.dta
>  not found)
file /scratch/kb103/stata/earnings_losses/control_Davis_ind_year2007.dta saved
(21064 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/control_Davis_ind_multi_year20
> 07.dta not found)
file /scratch/kb103/stata/earnings_losses/control_Davis_ind_multi_year2007.dta 
> saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           930,866  (_merge==3)
    -----------------------------------------
(note: file /scratch/kb103/stata/earnings_losses/EL_ind_year2007.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_ind_year2007.dta saved

    Result                           # of obs.
    -----------------------------------------
    not matched                             0
    matched                           474,849  (_merge==3)
    -----------------------------------------
(note: file /scratch/kb103/stata/earnings_losses/EL_Davis_ind_year2007.dta not 
> found)
file /scratch/kb103/stata/earnings_losses/EL_Davis_ind_year2007.dta saved

. 
. 
. * GENERATE ANNUAL INCOME
. forval yy = 2005/2007{
  2.         
.         * TREATMENT AND CONTROL IN A GIVEN DISPLACEMENT YEAR
.         use "`filepath'/EL_ind_year`yy'.dta"
  3.         drop if income==.
  4.         gen real_annual_income_T = income/30*btag/(cpi/100)
  5.         gen real_annual_income_coded_T = income_coded/30*btag/(cpi/100)
  6. 
.         sort pid year
  7.         by pid year: gen int index = _n
  8.         by pid year: egen real_annual_income = total(real_annual_income_T)
  9.         by pid year: egen real_annual_income_coded = total(real_annual_inc
> ome_coded_T)
 10.         keep if index == 1
 11.         drop index
 12.         keep year pid real_annual_income real_annual_income_coded day* sex
>  age CG* TG* fid_ML
 13.         gen int year_mass_layoff = `yy'
 14.         save "`filepath'/EL_annual_income_year`yy'.dta", replace
 15.         
.         * TREATMENT DAVIS MEASURE
.         
.         use "`filepath'/EL_Davis_ind_year`yy'.dta", clear
 16.         drop if income==.
 17.         gen real_annual_income_T = income/30*btag/(cpi/100)
 18.         gen real_annual_income_coded_T = income_coded/30*btag/(cpi/100)
 19. 
.         sort pid year
 20.         by pid year: gen int index = _n
 21.         by pid year: egen real_annual_income = total(real_annual_income_T)
 22.         by pid year: egen real_annual_income_coded = total(real_annual_inc
> ome_coded_T)
 23.         keep if index == 1
 24.         drop index
 25.         keep year pid real_annual_income real_annual_income_coded day* sex
>  age TG* fid_ML year_mass_layoff
 26. 
.         save "`filepath'/EL_Davis_annual_income_year`yy'.dta", replace       
>    
 27. }
(512612 observations deleted)
(3278902 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_annual_income_year2005.dta 
> not found)
file /scratch/kb103/stata/earnings_losses/EL_annual_income_year2005.dta saved
(9186 observations deleted)
(75094 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_Davis_annual_income_year200
> 5.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_Davis_annual_income_year2005.dta s
> aved
(10679 observations deleted)
(84175 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_annual_income_year2006.dta 
> not found)
file /scratch/kb103/stata/earnings_losses/EL_annual_income_year2006.dta saved
(10002 observations deleted)
(79257 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_Davis_annual_income_year200
> 6.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_Davis_annual_income_year2006.dta s
> aved
(31008 observations deleted)
(166274 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_annual_income_year2007.dta 
> not found)
file /scratch/kb103/stata/earnings_losses/EL_annual_income_year2007.dta saved
(13595 observations deleted)
(97970 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_Davis_annual_income_year200
> 7.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_Davis_annual_income_year2007.dta s
> aved

.         
. * CREATE FILES FOR REPLICATING DAVIS REGRESSIONS
. 
. forval yy = 2003/2005{  
  2.         * DEAL WITH DUPLICATE OBSERVATIONS - IF A WORKER IS IN MORE THAN O
> NE TREATMENT/CONTROL GROUP
.         
.         * CONTROL GROUP
.         use "`filepath'/EL_annual_income_year`yy'.dta"
  3.         keep if CG3_men==1 | CG3_women==1
  4.         keep pid CG3*
  5.         by pid: gen int index = _n
  6.         keep if index==1
  7.         drop index
  8.         saveold "`filepath'/EL_pid_CG3`yy'.dta", replace
  9. 
.         * TREATMENT GROUP
.         local endy = `yy'+2
 10.         forval yy1 = `yy'/`endy'{
 11.                 use "`filepath'/EL_Davis_annual_income_year`yy1'.dta"
 12.                 by pid: gen int index = _n
 13.                 keep if index == 1
 14.                 drop index
 15.                 keep pid TG* year_mass_layoff
 16.                 saveold "`filepath'/EL_pid_TG`yy1'.dta", replace
 17.         }
 18.         
.         use "`filepath'/EL_pid_CG3`yy'.dta", clear
 19.         forval yy1 = `yy'/`endy'{
 20.                 append using "`filepath'/EL_pid_TG`yy1'.dta"
 21.         }
 22. 
.         sort pid
 23.         by pid: gen int index = _n
 24.         by pid: egen int maxindex = max(index)
 25.         keep if maxindex>1
 26.         drop index maxindex
 27.         sort pid
 28.         by pid: gen int index = _n
 29.         keep if index==1
 30.         keep pid
 31.         save  "`filepath'/EL_`yy'_todrop.dta", replace
 32. 
.         * CREATE A FILE FOR REGRESSION
.         clear
 33.         use "`filepath'/EL_annual_income_year`yy'.dta" 
 34.         keep if CG3_men==1 | CG3_women==1
 35.         forval yy1 = `yy'/`endy'{
 36.                 append using "`filepath'/EL_Davis_annual_income_year`yy1'.
> dta"
 37.         }
 38.         merge m:1 pid using "`filepath'/EL_`yy'_todrop.dta"
 39.         drop if _merge==3
 40.         drop _merge
 41.         save "`filepath'/xregression_annual_income_year`yy'.dta" , replace
 42. }       
(2804554 observations deleted)
(16404952 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_CG32003.dta saved
(397720 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2003.dta saved
(557728 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2004.dta saved
(266554 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_pid_TG2005.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2005.dta saved
(788185 observations deleted)
(602 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_2003_todrop.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_2003_todrop.dta saved
(2804554 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                    18,389,927
        from master                18,389,927  (_merge==1)
        from using                          0  (_merge==2)

    matched                            26,414  (_merge==3)
    -----------------------------------------
(26414 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/xregression_annual_income_year
> 2003.dta not found)
file /scratch/kb103/stata/earnings_losses/xregression_annual_income_year2003.dt
> a saved
(2772536 observations deleted)
(15889410 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_pid_CG32004.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_pid_CG32004.dta saved
(557728 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2004.dta saved
(266554 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2005.dta saved
(306358 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_pid_TG2006.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2006.dta saved
(788306 observations deleted)
(545 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_2004_todrop.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_2004_todrop.dta saved
(2772536 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                    17,785,725
        from master                17,785,725  (_merge==1)
        from using                          0  (_merge==2)

    matched                            23,720  (_merge==3)
    -----------------------------------------
(23720 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/xregression_annual_income_year
> 2004.dta not found)
file /scratch/kb103/stata/earnings_losses/xregression_annual_income_year2004.dt
> a saved
(2793346 observations deleted)
(15503783 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_pid_CG32005.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_pid_CG32005.dta saved
(266554 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2005.dta saved
(306358 observations deleted)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2006.dta saved
(342337 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_pid_TG2007.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_pid_TG2007.dta saved
(791415 observations deleted)
(344 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/EL_2005_todrop.dta not found)
file /scratch/kb103/stata/earnings_losses/EL_2005_todrop.dta saved
(2793346 observations deleted)

    Result                           # of obs.
    -----------------------------------------
    not matched                    17,197,857
        from master                17,197,857  (_merge==1)
        from using                          0  (_merge==2)

    matched                            13,278  (_merge==3)
    -----------------------------------------
(13278 observations deleted)
(note: file /scratch/kb103/stata/earnings_losses/xregression_annual_income_year
> 2005.dta not found)
file /scratch/kb103/stata/earnings_losses/xregression_annual_income_year2005.dt
> a saved

. /*      
> * REGRESSIONS
> forval yy = 1976/2004{          
>         use "`filepath'/regression_annual_income_year`yy'.dta" , clear
>         gen byte treatmet =1 if TG4davis_men==1 | TG4davis_women==1
>         
>         * GENERATE Dtk dummies
>         * note: k0 is just to keep the index k non-positive
>         
>         forval tt = 1972/2007{
>                 local k0 = (`yy'+2) - `tt'      
>                 local k  = `tt'- `yy' + `k0'
>                 local k1 = `tt'-(`yy'+1) + `k0'
>                 local k2 = `tt'-(`yy'+2) + `k0'
>                 
>                 gen byte D_`tt'_`k'  = 0
>                 gen byte D_`tt'_`k1' = 0
>                 gen byte D_`tt'_`k2' = 0
>                 
>                 local tk  = `tt'-`k' + `k0'
>                 local tk1 = `tt'-`k1'+ `k0'
>                 local tk2 = `tt'-`k2'+ `k0'
>                 
>                 replace D_`tt'_`k'  = 1 if year==`tt' & year_mass_layoff == `
> tk'  & treatmet == 1
>                 replace D_`tt'_`k1' = 1 if year==`tt' & year_mass_layoff == `
> tk1' & treatmet == 1
>                 replace D_`tt'_`k2' = 1 if year==`tt' & year_mass_layoff == `
> tk2' & treatmet == 1
>         }
> 
>         gen age1 = year - year_mass_layoff + age
>         gen age2 = age1^2
>         gen age3 = age1^3
>         gen age4 = age1^4
>         save "`filepath'/regression_annual_income_year`yy'.dta", replace
>         
>         sort pid year
>         xtset pid year
>         save "`filepath'/regression_annual_income_year`yy'.dta", replace
>         
>         xi: xtreg real_annual_income i.year age1 age2 age3 age4 D_1976_2 - D_
> 1976_31 if sex==1, fe
>         xi: xtreg real_annual_income_coded i.year age age2 age3 age4 D_1976_2
>  - D_1976_31 if sex==1, fe
>         
>         xi: xtreg real_annual_income i.year age1 age2 age3 age4 D_1976_2 - D_
> 1976_31 if sex==2, fe
>         xi: xtreg real_annual_income_coded i.year age age2 age3 age4 D_1976_2
>  - D_1976_31 if sex==2, fe
> }       
> 

end of do-file
